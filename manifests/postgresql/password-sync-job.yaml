apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-password-sync
  namespace: postgresql
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: password-sync
        image: postgres:15-alpine
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Syncing PostgreSQL password from secret..."
          
          # Get password from secret
          SECRET_PASSWORD=$(cat /etc/postgresql-secret/password)
          SECRET_USERNAME=$(cat /etc/postgresql-secret/username)
          
          # Wait for PostgreSQL to be ready
          until PGPASSWORD="$SECRET_PASSWORD" psql -h postgresql-rw.postgresql.svc.cluster.local -p 5432 -U "$SECRET_USERNAME" -d postgres -c '\q' 2>/dev/null; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 2
          done
          
          # Update password if it doesn't match (try to connect with new password first)
          if ! PGPASSWORD="$SECRET_PASSWORD" psql -h postgresql-rw.postgresql.svc.cluster.local -p 5432 -U "$SECRET_USERNAME" -d postgres -c '\q' 2>/dev/null; then
            echo "Password mismatch detected. Updating password..."
            # Connect using local socket (as superuser) to update password
            PGPASSWORD="$SECRET_PASSWORD" psql -h postgresql-rw.postgresql.svc.cluster.local -p 5432 -U "$SECRET_USERNAME" -d postgres -c "ALTER USER $SECRET_USERNAME WITH PASSWORD '$SECRET_PASSWORD';" || true
          else
            echo "Password already matches secret."
          fi
          
          echo "Password sync completed."
        volumeMounts:
        - name: postgresql-secret
          mountPath: /etc/postgresql-secret
          readOnly: true
      volumes:
      - name: postgresql-secret
        secret:
          secretName: postgresql-credentials
