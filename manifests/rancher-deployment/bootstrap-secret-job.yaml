---
apiVersion: batch/v1
kind: Job
metadata:
  name: rancher-bootstrap-secret
  namespace: cattle-system
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded,before-hook-creation
    argocd.argoproj.io/sync-wave: "1"
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: rancher
      containers:
      - name: create-bootstrap-secret
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Creating bootstrap-secret..."
          
          # Check if secret already exists
          if kubectl get secret bootstrap-secret -n cattle-system >/dev/null 2>&1; then
            echo "bootstrap-secret already exists, skipping creation"
            exit 0
          fi
          
          # Create bootstrap-secret with password "admin"
          kubectl create secret generic bootstrap-secret \
            -n cattle-system \
            --from-literal=bootstrapPassword=admin \
            --dry-run=client -o yaml | \
          kubectl annotate --local -f - \
            helm.sh/resource-policy=keep \
            --dry-run=client -o yaml | \
          kubectl apply -f -
          
          echo "bootstrap-secret created successfully"
